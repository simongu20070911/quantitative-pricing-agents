project:
  name: qpa
  root: agents_workspace
  language: ocaml
  description: Intraday ES backtesting & optimization toolkit with reusable engine, pure-strategy packaging, plotting, and CLI runners.

modules:
  - name: Types
    file_ml: agents_workspace/lib/core/types.ml
    file_mli: null
    summary: Trading domain types for bars, setups, trades, lifecycle state, and performance stats.
    provides_types:
      - Types.direction
      - Types.timestamp
      - Types.bar_1m
      - Types.bar_5m
      - Types.day_macro
      - Types.setup
      - Types.exit_reason
      - Types.b2_follow
      - Types.trade
      - Types.trade_plan
      - Types.active_state
      - Types.trade_state
      - Types.perf_stats
    provides_values:
      - "string_of_direction : Types.direction -> string"
      - "string_of_exit_reason : Types.exit_reason -> string"

  - name: Time_utils
    file_ml: agents_workspace/lib/core/time_utils.ml
    file_mli: null
    summary: Time parsing helpers and RTH session constants.
    provides_values:
      - "minute_ofday_of_string : string -> int"
      - "parse_timestamp : string -> Types.timestamp"
      - rth_start_min : int
      - rth_end_min : int
      - b1_min : int
      - b2_min : int
      - abr_eod_min : int
      - minutes_per_day : int

  - name: Csv_parser
    file_ml: agents_workspace/lib/core/csv_parser.ml
    file_mli: null
    summary: Parse and stream 1-minute OHLCV bars from CSV files.
    provides_values:
      - "parse_bar_1m : string -> Types.bar_1m"
      - "iter_bars : string -> f:(Types.bar_1m -> unit) -> unit"

  - name: Parameters
    file_ml: agents_workspace/lib/core/parameters.ml
    file_mli: agents_workspace/lib/core/parameters.mli
    summary: Hyperparameter specifications with bounds, scaling, and overrides.
    provides_types:
      - Parameters.Scale.t
      - Parameters.t
      - Parameters.value_map
    provides_values:
      - "make : ?bounds:(float * float) -> ?scale:Parameters.Scale.t -> ?fixed:bool -> ?integer:bool -> ?description:string -> name:string -> default:float -> unit -> Parameters.t"
      - "clamp : Parameters.t -> float -> float"
      - "validate : Parameters.t -> float -> (unit, string) result"
      - "to_string : Parameters.t -> string"
      - "default_map : Parameters.t list -> Parameters.value_map"
      - "merge_overrides : Parameters.t list -> Parameters.value_map -> Parameters.value_map"

  - name: Guardrails
    file_ml: agents_workspace/lib/core/guardrails.ml
    file_mli: agents_workspace/lib/core/guardrails.mli
    summary: Optimization guardrail settings with YAML loading and hashing.
    provides_types:
      - Guardrails.t
    provides_values:
      - default : Guardrails.t
      - "apply_overrides : Guardrails.t -> Yojson.Safe.t -> Guardrails.t"
      - "load : ?path:string -> ?strategy_id:string -> unit -> (Guardrails.t, string) result"
      - "hash : Guardrails.t -> string"

  - name: Position_sizing
    file_ml: agents_workspace/lib/core/position_sizing.ml
    file_mli: agents_workspace/lib/core/position_sizing.mli
    summary: Vol-targeted position sizing utilities.
    provides_values:
      - "vol_target_units : max:int -> signal:float -> sigma:float option -> int"
      - "vol_target_scale : signal:float -> sigma:float option -> float"

  - name: Cost_model
    file_ml: agents_workspace/lib/core/cost_model.ml
    file_mli: agents_workspace/lib/core/cost_model.mli
    summary: Per-contract slippage/fee adjustments with optional equity_base for pct PnL.
    provides_types:
      - Cost_model.config
    provides_values:
      - "apply : qty:float -> Cost_model.config -> Types.trade -> Types.trade"

  - name: Trade_base
    file_ml: agents_workspace/lib/core/trade_base.ml
    file_mli: agents_workspace/lib/core/trade_base.mli
    summary: Core trade constructors and cost application helpers.
    provides_values:
      - "make_raw : qty:float -> r_pts:float -> direction:Types.direction -> entry_ts:Types.timestamp -> entry_px:float -> exit_ts:Types.timestamp -> exit_px:float -> exit_reason:Types.exit_reason -> meta:(string * string) list -> Types.trade"
      - "apply_costs : qty:float -> Cost_model.config -> Types.trade -> Types.trade"

  - name: Summary
    file_ml: agents_workspace/lib/core/summary.ml
    file_mli: agents_workspace/lib/core/summary.mli
    summary: Compute and print performance statistics (Sharpe, drawdown, skew); export trades and daily PnL to CSV.
    provides_values:
      - "compute_stats : ?daily_usd:(Date.t * float) list -> ?daily_pct:(Date.t * float) list -> Types.trade list -> (Date.t * float) list -> Types.perf_stats"
      - "print_stats : Types.perf_stats -> unit"
      - "print_sample_trades : Types.trade list -> int -> unit"
      - "export_trades_csv : outfile:string -> trades:Types.trade list -> unit"
      - "export_daily_csv : outfile:string -> daily:(Date.t * float) list -> ?daily_usd:(Date.t * float) list -> ?daily_pct:(Date.t * float) list -> unit -> unit"

  - name: Policy_sig
    file_ml: agents_workspace/lib/engine/policy_sig.ml
    file_mli: agents_workspace/lib/engine/policy_sig.mli
    summary: Policy callback signature for per-bar execution.
    provides_values: []

  - name: Strategy_sig
    file_ml: agents_workspace/lib/engine/strategy_sig.ml
    file_mli: agents_workspace/lib/engine/strategy_sig.mli
    summary: Pure strategy interface with runtime env and per-bar callbacks.
    provides_types:
      - Strategy_sig.env
    provides_values: []

  - name: Trade_transition
    file_ml: agents_workspace/lib/engine/trade_transition.ml
    file_mli: agents_workspace/lib/engine/trade_transition.mli
    summary: Stateless trade lifecycle transition for a single trade_plan.
    provides_values:
      - "step : plan:Types.trade_plan -> state:Types.trade_state -> bar:Types.bar_1m -> record_trade:(active:Types.active_state -> exit_ts:Types.timestamp -> exit_price:float -> exit_reason:Types.exit_reason -> 'a) -> Types.trade_state * 'a list"

  - name: Engine
    file_ml: agents_workspace/lib/engine/engine.ml
    file_mli: agents_workspace/lib/engine/engine.mli
    summary: Generic engine that runs pure Strategy_sig strategies with optional setup builders.
    provides_types:
      - Engine.strategy
      - Engine.pure_strategy
      - Engine.run_result
    provides_values:
      - "run : Engine.strategy -> filename:string -> Engine.run_result"
      - "run_pure : Engine.pure_strategy -> filename:string -> Engine.run_result"
      - "legacy_of_pure : id:string -> env:Strategy_sig.env -> ?build_setups:(string -> Types.setup Core.Date.Table.t) -> (module Strategy_sig.S) -> Engine.strategy"

  - name: Backtest
    file_ml: agents_workspace/lib/engine/backtest.ml
    file_mli: agents_workspace/lib/engine/backtest.mli
    summary: Lower-level backtest with explicit trade-plan lifecycle and policy hooks.
    provides_types:
      - Backtest.engine_config
    provides_values:
      - "run : config:Backtest.engine_config -> string -> Types.setup Core.Date.Table.t -> Types.trade list * (Date.t * float) list"

  - name: Multi_engine
    file_ml: agents_workspace/lib/engine/multi_engine.ml
    file_mli: agents_workspace/lib/engine/multi_engine.mli
    summary: Run multiple strategies independently or sharing streamed bars.
    provides_types:
      - Multi_engine.run_result
    provides_values:
      - "run_all : Engine.strategy list -> filename:string -> Multi_engine.run_result list"
      - "run_all_pure : Engine.pure_strategy list -> filename:string -> Multi_engine.run_result list"
      - "run_shared_with_stream : stream:(module Multi_engine.BAR_STREAM) -> make_setups:(Engine.strategy -> Types.setup Core.Date.Table.t) -> Engine.strategy list -> Multi_engine.run_result list"
      - "run_shared : Engine.strategy list -> filename:string -> Multi_engine.run_result list"
      - "run_shared_pure : Engine.pure_strategy list -> filename:string -> Multi_engine.run_result list"

  - name: Pnl_agg
    file_ml: agents_workspace/lib/engine/pnl_agg.ml
    file_mli: agents_workspace/lib/engine/pnl_agg.mli
    summary: Shared daily PnL accumulator for engine runners.
    provides_types:
      - Pnl_agg.t
    provides_values:
      - Pnl_agg.empty
      - "add_trade : Pnl_agg.t -> Types.trade -> Pnl_agg.t"
      - "add_trades : Pnl_agg.t -> Types.trade list -> Pnl_agg.t"
      - "to_alists_unsorted : Pnl_agg.t -> (Date.t * float) list * (Date.t * float) list * (Date.t * float) list"

  - name: Opt_algos
    file_ml: agents_workspace/lib/engine/opt_algos.ml
    file_mli: agents_workspace/lib/engine/opt_algos.mli
    summary: Sampling algorithms for hyperparameter search (grid, random, LHS, Gaussian perturbation).
    provides_types:
      - Opt_algos.sampler
    provides_values:
      - random_uniform : Opt_algos.sampler
      - latin_hypercube : Opt_algos.sampler
      - "grid : steps:int -> Opt_algos.sampler"
      - "perturb_around : center:Parameters.value_map -> specs:Parameters.t list -> sigma_frac:float -> seed:int -> Parameters.value_map"

  - name: Stat_tests
    file_ml: agents_workspace/lib/engine/stat_tests.ml
    file_mli: agents_workspace/lib/engine/stat_tests.mli
    summary: Permutation and bootstrap utilities for guardrail testing.
    provides_values:
      - "permutation_pvalue : ?reps:int -> ?seed:int -> metric:(float list -> float) -> float list -> float"
      - "bootstrap_ci : ?reps:int -> ?alpha:float -> ?seed:int -> float list -> float * float"

  - name: Robustness
    file_ml: agents_workspace/lib/engine/robustness.ml
    file_mli: agents_workspace/lib/engine/robustness.mli
    summary: Perturbation sweeps to assess parameter stability and cliffs.
    provides_types:
      - Robustness.perturbation
      - Robustness.result
    provides_values:
      - "run : specs:Parameters.t list -> bump_factors:float list -> tol_frac:float -> cliff_pct:float -> evaluate:(Parameters.value_map -> float) -> ?baseline_score:float -> Parameters.value_map -> Robustness.result"

  - name: Optimizer
    file_ml: agents_workspace/lib/engine/optimizer.ml
    file_mli: agents_workspace/lib/engine/optimizer.mli
    summary: Parameter search with guardrails, statistical tests, caching, robustness, and sampling modes.
    provides_types:
      - Optimizer.objective
      - Optimizer.search
      - Optimizer.job
      - Optimizer.candidate
      - Optimizer.result
    provides_values:
      - "run : Optimizer.job -> evaluate:(Parameters.value_map -> Optimizer.candidate) -> Optimizer.result"

  - name: Indicators
    file_ml: agents_workspace/lib/features/indicators.ml
    file_mli: agents_workspace/lib/features/indicators.mli
    summary: Rolling ABR/ADR feature calculators.
    provides_types:
      - Indicators.Abr.t
      - Indicators.Adr.t
    provides_values:
      - "Abr.create : n:int -> Indicators.Abr.t"
      - "Abr.update : Indicators.Abr.t -> float -> unit"
      - "Abr.value : Indicators.Abr.t -> float option"
      - "Adr.create : n:int -> Indicators.Adr.t"
      - "Adr.update : Indicators.Adr.t -> float -> unit"
      - "Adr.value : Indicators.Adr.t -> float option"

  - name: Features
    file_ml: agents_workspace/lib/features/features.ml
    file_mli: agents_workspace/lib/features/features.mli
    summary: Maintains rolling intraday VWAP/OFI/volatility/overnight feature set.
    provides_types:
      - Features.state
      - Features.snapshot
    provides_values:
      - "create : unit -> Features.state"
      - "update : Features.state -> Types.bar_1m -> Features.state"
      - "snapshot : Features.state -> Features.snapshot"

  - name: Plotter
    file_ml: agents_workspace/lib/plot/plotter.ml
    file_mli: agents_workspace/lib/plot/plotter.mli
    summary: Render equity curves and histograms to PNG via Cairo.
    provides_values:
      - "render_equity : outfile:string -> trades:Types.trade list -> unit"
      - "render_daily_curve : outfile:string -> daily:(Date.t * float) list -> unit"
      - "render_histogram : outfile:string -> values:float array -> bins:int -> unit"

  - name: Strategy_common
    file_ml: agents_workspace/lib/strategies/common/strategy_common.ml
    file_mli: agents_workspace/lib/strategies/common/strategy_common.mli
    summary: Shared trade construction, cost/session parameter helpers, tunable surfaces, and setup utilities.
    provides_types:
      - Strategy_common.Tunables.env_defaults
      - Strategy_common.Tunables.param_field
    provides_values:
      - "Trade.make : qty:float -> ?r_pts:float -> Cost_model.config -> Types.direction -> entry_ts:Types.timestamp -> entry_px:float -> exit_ts:Types.timestamp -> exit_px:float -> reason:Types.exit_reason -> meta:(string * string) list -> Types.trade"
      - "Config.cost_params : Cost_model.config -> Parameters.t list"
      - "Config.cost_of_params : defaults:Cost_model.config -> Parameters.value_map -> Cost_model.config"
      - "Config.session_params : default_start:int -> default_end:int -> Parameters.t list"
      - "Config.session_of_params : defaults:(int * int) -> Parameters.value_map -> int * int"
      - "Tunables.env_specs : defaults:Strategy_common.Tunables.env_defaults -> Parameters.t list"
      - "Tunables.env_of_params : defaults:Strategy_common.Tunables.env_defaults -> Parameters.value_map -> Strategy_common.Tunables.env_defaults"
      - "Tunables.parameter_specs_of_table : 'p Strategy_common.Tunables.param_field list -> Parameters.t list"
      - "Tunables.params_of_table : defaults:'p -> param_table:'p Strategy_common.Tunables.param_field list -> Parameters.value_map -> 'p"
      - "Tunables.make : defaults_env:Strategy_common.Tunables.env_defaults -> defaults_params:'p -> param_table:'p Strategy_common.Tunables.param_field list -> Parameters.t list * (Parameters.value_map -> Strategy_common.Tunables.env_defaults * 'p)"
      - "Env.of_config : session_start_min:int -> session_end_min:int -> qty:float -> cost:Cost_model.config -> Strategy_sig.env"
      - "Session.within : start:int -> end_:int -> Types.bar_1m -> bool"
      - "Session.eod_flat : qty:float -> ?r_pts:float -> Cost_model.config -> direction:Types.direction -> entry_ts:Types.timestamp -> entry_px:float -> last_bar:Types.bar_1m -> meta:(string * string) list -> Types.trade"
      - "Setup.noop : string -> Types.setup Core.Date.Table.t"
      - "Setups.with_params : params:'p -> ('p -> string -> Types.setup Core.Date.Table.t) -> string -> Types.setup Core.Date.Table.t"
      - "Strategy_builder.make_pure : id:string -> env:Strategy_sig.env -> ?build_setups:(string -> Types.setup Core.Date.Table.t) -> (module Strategy_sig.S) -> Engine.pure_strategy"
      - "Trade_common.with_strategy : string -> (string * string) list -> (string * string) list"

  - name: B1b2_params
    file_ml: agents_workspace/lib/strategies/b1b2/b1b2_params.ml
    file_mli: agents_workspace/lib/strategies/b1b2/b1b2_params.mli
    summary: Single source of B1/B2 setup and execution tunables with parameter specs and overrides.
    provides_types:
      - B1b2_params.Setup.t
      - B1b2_params.Exec.t
      - B1b2_params.t
      - B1b2_params.field
    provides_values:
      - "Setup.param_table : B1b2_params.Setup.field list"
      - "Setup.defaults : B1b2_params.Setup.t"
      - "Setup.parameter_specs : Parameters.t list"
      - "Setup.apply_overrides : Parameters.value_map -> B1b2_params.Setup.t -> B1b2_params.Setup.t"
      - "Exec.param_table : B1b2_params.Exec.field list"
      - "Exec.defaults : B1b2_params.Exec.t"
      - "Exec.parameter_specs : Parameters.t list"
      - "Exec.apply_overrides : Parameters.value_map -> B1b2_params.Exec.t -> B1b2_params.Exec.t"
      - defaults : B1b2_params.t
      - param_table : B1b2_params.field list
      - parameter_specs : Parameters.t list
      - "apply_overrides : Parameters.value_map -> B1b2_params.t -> B1b2_params.t"

  - name: Setup_builder_b1b2
    file_ml: agents_workspace/lib/strategies/b1b2/setup_builder_b1b2.ml
    file_mli: agents_workspace/lib/strategies/b1b2/setup_builder_b1b2.mli
    summary: Build B1/B2 daily setups via reusable bar aggregation (day macro, 5m pivots, ABR/ADR) then assemble setups.
    provides_types:
      - Setup_builder_b1b2.agg_tables
    provides_values:
      - "aggregate_bars : B1b2_params.Setup.t -> string -> Setup_builder_b1b2.agg_tables"
      - "build_setups : B1b2_params.Setup.t -> Setup_builder_b1b2.agg_tables -> Types.setup Core.Date.Table.t"
      - "build : B1b2_params.Setup.t -> string -> Types.setup Core.Date.Table.t"
      - "build_with_defaults : string -> Types.setup Core.Date.Table.t"

  - name: Trade_logic
    file_ml: agents_workspace/lib/strategies/b1b2/trade_logic.ml
    file_mli: null
    summary: Build B1/B2 trade plans from daily setup context and exec params.
    provides_values:
      - "build_trade_plan : params:B1b2_params.Exec.t -> Types.setup -> Types.trade_plan option"

  - name: Strategy_b1b2
    file_ml: agents_workspace/lib/strategies/b1b2/strategy_b1b2.ml
    file_mli: agents_workspace/lib/strategies/b1b2/strategy_b1b2.mli
    summary: Pure strategy wrapper for classic B1/B2 setup with session/qty/cost tuning and param overrides.
    provides_types:
      - Strategy_b1b2.config
    provides_values:
      - default_config : Strategy_b1b2.config
      - strategy_id : string
      - "parameter_specs : Parameters.t list"
      - "config_of_params : Parameters.value_map -> Strategy_b1b2.config"
      - "session_window : Strategy_b1b2.config -> int * int"
      - "qty : Strategy_b1b2.config -> float"
      - "cost : Strategy_b1b2.config -> Cost_model.config"
      - "with_params : params:B1b2_params.t -> Strategy_b1b2.config -> Strategy_b1b2.config"
      - "with_cost : cost:Cost_model.config -> Strategy_b1b2.config -> Strategy_b1b2.config"
      - "with_qty : qty:float -> Strategy_b1b2.config -> Strategy_b1b2.config"
      - "with_session : start:int -> end_:int -> Strategy_b1b2.config -> Strategy_b1b2.config"
      - "params : Strategy_b1b2.config -> B1b2_params.t"
      - "pure_strategy : Strategy_b1b2.config -> Engine.pure_strategy"
      - strategy_pure : Engine.pure_strategy

  - name: Vwap_revert_params
    file_ml: agents_workspace/lib/strategies/vwap_revert/vwap_revert_params.ml
    file_mli: agents_workspace/lib/strategies/vwap_revert/vwap_revert_params.mli
    summary: VWAP reversion strategy tunables with parameter specs and overrides.
    provides_types:
      - Vwap_revert_params.t
      - Vwap_revert_params.field
    provides_values:
      - param_table : Vwap_revert_params.field list
      - defaults : Vwap_revert_params.t
      - parameter_specs : Parameters.t list
      - "apply_overrides : Parameters.value_map -> Vwap_revert_params.t -> Vwap_revert_params.t"

  - name: Vwap_revert_strategy
    file_ml: agents_workspace/lib/strategies/vwap_revert/vwap_revert_strategy.ml
    file_mli: agents_workspace/lib/strategies/vwap_revert/vwap_revert_strategy.mli
    summary: VWAP mean-reversion strategy with volatility targeting and cost model.
    provides_types:
      - Vwap_revert_strategy.config
    provides_values:
      - default_config : Vwap_revert_strategy.config
      - strategy_id : string
      - "parameter_specs : Parameters.t list"
      - "config_of_params : Parameters.value_map -> Vwap_revert_strategy.config"
      - "session_window : Vwap_revert_strategy.config -> int * int"
      - "qty : Vwap_revert_strategy.config -> float"
      - "cost : Vwap_revert_strategy.config -> Cost_model.config"
      - "with_cost : cost:Cost_model.config -> Vwap_revert_strategy.config -> Vwap_revert_strategy.config"
      - "with_s_entry : s_entry:float -> Vwap_revert_strategy.config -> Vwap_revert_strategy.config"
      - "with_z_exit : z_exit:float -> Vwap_revert_strategy.config -> Vwap_revert_strategy.config"
      - "with_session : start:int -> end_:int -> Vwap_revert_strategy.config -> Vwap_revert_strategy.config"
      - "with_qty : qty:float -> Vwap_revert_strategy.config -> Vwap_revert_strategy.config"
      - "pure_strategy : Vwap_revert_strategy.config -> Engine.pure_strategy"
      - strategy_pure : Engine.pure_strategy

  - name: Strategy_registry
    file_ml: agents_workspace/lib/strategy_registry.ml
    file_mli: null
    summary: Registry mapping strategy_id to parameter specs and builders for pure strategies.
    provides_types:
      - Strategy_registry.pack
    provides_values:
      - "all : unit -> Strategy_registry.pack list"
      - "find : string -> Strategy_registry.pack option"
      - "find_exn : string -> Strategy_registry.pack"

  - name: Strategy_fast
    file_ml: agents_workspace/lib/strategy_fast.ml
    file_mli: null
    summary: Umbrella module re-exporting core, engine, feature, plot, strategy modules, and strategy registry for CLI builds.
    provides_values: []

  - name: Trade_transition_tests
    file_ml: agents_workspace/tests/trade_transition_tests.ml
    file_mli: null
    summary: Inline expect tests for Trade_transition stop/target ordering and downgrade behavior.
    provides_values: []

  - name: Engine_pure_parity_tests
    file_ml: agents_workspace/tests/engine_pure_parity_tests.ml
    file_mli: null
    summary: Verify pure strategies match configs built from default parameter maps.
    provides_values: []

  - name: Engine_backtest_parity_tests
    file_ml: agents_workspace/tests/engine_backtest_parity_tests.ml
    file_mli: null
    summary: Ensure Backtest.run matches Engine.run_pure results for B1/B2.
    provides_values: []

  - name: Opt_algos_tests
    file_ml: agents_workspace/tests/opt_algos_tests.ml
    file_mli: null
    summary: Check sampling algorithms respect bounds, integer flags, and coverage.
    provides_values: []

  - name: Regression_b1b2_tests
    file_ml: agents_workspace/tests/regression_b1b2_tests.ml
    file_mli: null
    summary: Golden baseline for B1/B2 trades and PnL on sample_es.csv.
    provides_values: []

  - name: Optimizer_tests
    file_ml: agents_workspace/tests/optimizer_tests.ml
    file_mli: null
    summary: Guardrail, caching, and Bayesian search behavior tests for Optimizer.run.
    provides_values: []

  - name: Multi_engine_shared_tests
    file_ml: agents_workspace/tests/multi_engine_shared_tests.ml
    file_mli: null
    summary: Parity and determinism tests for Multi_engine shared-stream runners.
    provides_values: []

  - name: Property_determinism_tests
    file_ml: agents_workspace/tests/property_determinism_tests.ml
    file_mli: null
    summary: Property test confirming bar permutation determinism for B1/B2 strategy.
    provides_values: []

  - name: Csv_parser_tests
    file_ml: agents_workspace/tests/csv_parser_tests.ml
    file_mli: null
    summary: Unit tests for Csv_parser.parse_bar_1m column selection and error handling.
    provides_values: []

  - name: Position_sizing_edge_tests
    file_ml: agents_workspace/tests/position_sizing_edge_tests.ml
    file_mli: null
    summary: Edge-case tests for vol_target_units/vol_target_scale rounding and caps.
    provides_values: []

  - name: Time_utils_tests
    file_ml: agents_workspace/tests/time_utils_tests.ml
    file_mli: null
    summary: RFC3339 parsing tests covering offsets, seconds validation, legacy format acceptance.
    provides_values: []

  - name: Summary_edge_tests
    file_ml: agents_workspace/tests/summary_edge_tests.ml
    file_mli: null
    summary: Tests for compute_stats Sharpe None path and drawdown order-independence.
    provides_values: []

  - name: Core_primitives_tests
    file_ml: agents_workspace/tests/core_primitives_tests.ml
    file_mli: null
    summary: Comprehensive tests for position sizing, cost model, trade_base durations, and summary stats.
    provides_values: []

  - name: Setup_builder_b1b2_tests
    file_ml: agents_workspace/tests/setup_builder_b1b2_tests.ml
    file_mli: null
    summary: Validates refactored B1B2 bar aggregation plus setup assembly equals legacy build.
    provides_values: []

  - name: Test_utils
    file_ml: agents_workspace/tests/test_utils.ml
    file_mli: null
    summary: Shared test helpers (e.g., locating sample_es.csv fixture).
    provides_values:
      - "find_fixture : unit -> string"

signatures:
  - name: Policy_sig.S
    file_mli: agents_workspace/lib/engine/policy_sig.mli
    description: Strategy policy callbacks for init, per-bar handling, and session close.
    types:
      - t
    values:
      - "init_day : Types.setup option -> t"
      - "on_bar : t -> Types.bar_1m -> t * Types.trade list"
      - "on_session_end : t -> Types.bar_1m option -> t * Types.trade list"
    implemented_by: []

  - name: Strategy_sig.S
    file_mli: agents_workspace/lib/engine/strategy_sig.mli
    description: Pure strategy callbacks operating with Strategy_sig.env.
    types:
      - state
    values:
      - "init : Types.setup option -> state"
      - "step : Strategy_sig.env -> state -> Types.bar_1m -> state * Types.trade list"
    
      - "finalize_day : Strategy_sig.env -> state -> Types.bar_1m option -> state * Types.trade list"
    implemented_by:
      - Strategy_b1b2.Pure
      - Vwap_revert_strategy.Pure

  - name: Multi_engine.BAR_STREAM
    file_mli: agents_workspace/lib/engine/multi_engine.mli
    description: Minimal streaming interface for shared multi-strategy execution.
    types: []
    values:
      - "iter : f:(Types.bar_1m -> unit) -> unit"
    implemented_by: []

functors:
  - name: Vwap_revert_strategy.Pure
    file_ml: agents_workspace/lib/strategies/vwap_revert/vwap_revert_strategy.ml
    file_mli: agents_workspace/lib/strategies/vwap_revert/vwap_revert_strategy.mli
    description: Functor producing VWAP revert pure strategy module implementing Strategy_sig.S from a config.
    type:
      params:
        - Cfg: { cfg: Vwap_revert_strategy.config }
      result: Strategy_sig.S
    param_signatures: []
    result_signature: Strategy_sig.S

types:
  - name: Types.direction
    defined_in_module: Types
    file_mli: null
    description: Trade direction (long or short).
    representation: variant

  - name: Types.timestamp
    defined_in_module: Types
    file_mli: null
    description: Date and minute-of-day timestamp.
    representation: record

  - name: Types.bar_1m
    defined_in_module: Types
    file_mli: null
    description: 1-minute OHLCV bar with timestamp and volume.
    representation: record

  - name: Types.bar_5m
    defined_in_module: Types
    file_mli: null
    description: Aggregated 5-minute bar tracked for setup logic.
    representation: record

  - name: Types.day_macro
    defined_in_module: Types
    file_mli: null
    description: Running RTH high/low/close context for a trading day.
    representation: record

  - name: Types.setup
    defined_in_module: Types
    file_mli: null
    description: B1/B2 setup built from first 5-minute bars and prior context.
    representation: record

  - name: Types.exit_reason
    defined_in_module: Types
    file_mli: null
    description: Trade exit classification (stop, target, EOD flat).
    representation: variant

  - name: Types.b2_follow
    defined_in_module: Types
    file_mli: null
    description: Quality flag for B2 follow-through.
    representation: variant

  - name: Types.trade
    defined_in_module: Types
    file_mli: null
    description: Executed trade with entry/exit, qty, pnl (R/pts/USD/pct), and metadata.
    representation: record

  - name: Types.trade_plan
    defined_in_module: Types
    file_mli: null
    description: Planned trade parameters prior to execution.
    representation: record

  - name: Types.active_state
    defined_in_module: Types
    file_mli: null
    description: Live trade state with trailing stop and entry timestamp.
    representation: record

  - name: Types.trade_state
    defined_in_module: Types
    file_mli: null
    description: Trade lifecycle state machine.
    representation: variant

  - name: Types.perf_stats
    defined_in_module: Types
    file_mli: null
    description: Aggregate performance statistics (R, USD, pct) with drawdowns and skew over trades and days.
    representation: record

  - name: Parameters.Scale.t
    defined_in_module: Parameters
    file_mli: agents_workspace/lib/core/parameters.mli
    description: Scaling mode for parameter sampling (linear or log).
    representation: variant

  - name: Parameters.t
    defined_in_module: Parameters
    file_mli: agents_workspace/lib/core/parameters.mli
    description: Hyperparameter specification with bounds, scale, and defaults.
    representation: record

  - name: Parameters.value_map
    defined_in_module: Parameters
    file_mli: agents_workspace/lib/core/parameters.mli
    description: Map from parameter names to float values.
    representation: alias

  - name: Guardrails.t
    defined_in_module: Guardrails
    file_mli: agents_workspace/lib/core/guardrails.mli
    description: Guardrail thresholds for optimization validity checks.
    representation: record

  - name: Cost_model.config
    defined_in_module: Cost_model
    file_mli: agents_workspace/lib/core/cost_model.mli
    description: Slippage, fee, and optional equity_base parameters used to adjust trades.
    representation: record

  - name: Strategy_common.Tunables.env_defaults
    defined_in_module: Strategy_common
    file_mli: agents_workspace/lib/strategies/common/strategy_common.mli
    description: Default environment tuple (session window, qty, cost) for strategy surfaces.
    representation: record

  - name: Strategy_common.Tunables.param_field
    defined_in_module: Strategy_common
    file_mli: agents_workspace/lib/strategies/common/strategy_common.mli
    description: Metadata for a tunable parameter (name, bounds, setter, flags).
    representation: record

  - name: B1b2_params.Setup.t
    defined_in_module: B1b2_params
    file_mli: agents_workspace/lib/strategies/b1b2/b1b2_params.mli
    description: Tunable thresholds for B1/B2 setup selection.
    representation: record

  - name: B1b2_params.Exec.t
    defined_in_module: B1b2_params
    file_mli: agents_workspace/lib/strategies/b1b2/b1b2_params.mli
    description: Execution parameters for entries, stops, and downgrades.
    representation: record

  - name: B1b2_params.t
    defined_in_module: B1b2_params
    file_mli: agents_workspace/lib/strategies/b1b2/b1b2_params.mli
    description: Combined setup and execution parameter set for B1/B2.
    representation: record

  - name: B1b2_params.field
    defined_in_module: B1b2_params
    file_mli: agents_workspace/lib/strategies/b1b2/b1b2_params.mli
    description: Metadata for a single B1/B2 parameter (name, bounds, setter, tunable flag).
    representation: record

  - name: Vwap_revert_params.t
    defined_in_module: Vwap_revert_params
    file_mli: agents_workspace/lib/strategies/vwap_revert/vwap_revert_params.mli
    description: Tunable parameter set for VWAP mean-reversion policy.
    representation: record

  - name: Vwap_revert_params.field
    defined_in_module: Vwap_revert_params
    file_mli: agents_workspace/lib/strategies/vwap_revert/vwap_revert_params.mli
    description: Metadata for a VWAP-revert parameter (bounds, setter, tunable flag).
    representation: record

  - name: Strategy_sig.env
    defined_in_module: Strategy_sig
    file_mli: agents_workspace/lib/engine/strategy_sig.mli
    description: Runtime environment (session window, qty, cost) passed to pure strategies.
    representation: record

  - name: Engine.strategy
    defined_in_module: Engine
    file_mli: agents_workspace/lib/engine/engine.mli
    description: Strategy wired with optional setup builder and policy.
    representation: record

  - name: Engine.pure_strategy
    defined_in_module: Engine
    file_mli: agents_workspace/lib/engine/engine.mli
    description: Pure strategy with Strategy_sig env and optional setup builder.
    representation: record

  - name: Engine.run_result
    defined_in_module: Engine
    file_mli: agents_workspace/lib/engine/engine.mli
    description: Result of Engine.run/run_pure containing setups, trades, and per-day pnl (R/USD/pct).
    representation: record

  - name: Backtest.engine_config
    defined_in_module: Backtest
    file_mli: agents_workspace/lib/engine/backtest.mli
    description: Configuration for low-level backtest driver.
    representation: record

  - name: Multi_engine.run_result
    defined_in_module: Multi_engine
    file_mli: agents_workspace/lib/engine/multi_engine.mli
    description: Per-strategy outcomes including trades and daily PnL (R/USD/pct).
    representation: record

  - name: Pnl_agg.t
    defined_in_module: Pnl_agg
    file_mli: agents_workspace/lib/engine/pnl_agg.mli
    description: Aggregator of trades and daily R/USD/pct PnL maps.
    representation: record

  - name: Strategy_b1b2.config
    defined_in_module: Strategy_b1b2
    file_mli: agents_workspace/lib/strategies/b1b2/strategy_b1b2.mli
    description: Session window, qty, cost, and param configuration for B1/B2 strategy packaging.
    representation: abstract

  - name: Vwap_revert_strategy.config
    defined_in_module: Vwap_revert_strategy
    file_mli: agents_workspace/lib/strategies/vwap_revert/vwap_revert_strategy.mli
    description: Parameter set for VWAP mean-reversion policy (features, risk, cost).
    representation: abstract

  - name: Features.state
    defined_in_module: Features
    file_mli: agents_workspace/lib/features/features.mli
    description: Rolling feature computation state.
    representation: abstract

  - name: Features.snapshot
    defined_in_module: Features
    file_mli: agents_workspace/lib/features/features.mli
    description: Captured feature vector (VWAP, OFI, vol ratios, overnight distances).
    representation: record

  - name: Indicators.Abr.t
    defined_in_module: Indicators
    file_mli: agents_workspace/lib/features/indicators.mli
    description: Rolling average bar range accumulator.
    representation: abstract

  - name: Indicators.Adr.t
    defined_in_module: Indicators
    file_mli: agents_workspace/lib/features/indicators.mli
    description: Rolling average daily range accumulator.
    representation: abstract

  - name: Opt_algos.sampler
    defined_in_module: Opt_algos
    file_mli: agents_workspace/lib/engine/opt_algos.mli
    description: Sampling function to produce parameter grids/sets.
    representation: function

  - name: Robustness.perturbation
    defined_in_module: Robustness
    file_mli: agents_workspace/lib/engine/robustness.mli
    description: Score for a single bumped-parameter evaluation.
    representation: record

  - name: Robustness.result
    defined_in_module: Robustness
    file_mli: agents_workspace/lib/engine/robustness.mli
    description: Stability metrics and cliff detection summary.
    representation: record

  - name: Optimizer.objective
    defined_in_module: Optimizer
    file_mli: agents_workspace/lib/engine/optimizer.mli
    description: Objective function choice (Sharpe, mean pnl, hit rate, custom).
    representation: variant

  - name: Optimizer.search
    defined_in_module: Optimizer
    file_mli: agents_workspace/lib/engine/optimizer.mli
    description: Search mode (grid, random, latin hypercube, Bayes).
    representation: variant

  - name: Optimizer.job
    defined_in_module: Optimizer
    file_mli: agents_workspace/lib/engine/optimizer.mli
    description: Parameter search job configuration including specs, objective, guardrails, robustness, caching.
    representation: record

  - name: Optimizer.candidate
    defined_in_module: Optimizer
    file_mli: agents_workspace/lib/engine/optimizer.mli
    description: Evaluated parameter set with score, trades, and daily pnl.
    representation: record

  - name: Optimizer.result
    defined_in_module: Optimizer
    file_mli: agents_workspace/lib/engine/optimizer.mli
    description: Best candidate summary plus guardrail/rejection counts and cache hits.
    representation: record

pipelines:
  - id: b1b2_cli
    module: Strategy_fast_main
    file_ml: agents_workspace/bin/strategy_fast_main.ml
    file_mli: null
    description: Command-line B1/B2 backtest over CSV input with optional cost/qty overrides, PNG plots, and CSV export.
    signature: null
    entry_value: main
    entry_type: "?plot_dir:string -> ?export_trades:string -> ?export_daily:string -> ?plot_python:string -> cfg:Strategy_fast.Strategies.Strategy_b1b2.config -> string -> unit"
    uses_modules:
      - Strategy_fast
      - Engine
      - Strategy_b1b2
      - Summary
      - Plotter
    uses_signatures:
      - Strategy_sig.S

  - id: vwap_revert_cli
    module: Vwap_revert_main
    file_ml: agents_workspace/bin/vwap_revert_main.ml
    file_mli: null
    description: CLI VWAP mean-revert backtest over CSV input with tunable cost/slippage, plots, and CSV export.
    signature: null
    entry_value: main
    entry_type: "slippage:float -> fees:float -> s_entry:float -> z_exit:float -> ?plot_dir:string -> ?export_trades:string -> ?export_daily:string -> ?plot_python:string -> string -> unit"
    uses_modules:
      - Strategy_fast
      - Engine
      - Vwap_revert_strategy
      - Summary
      - Plotter
    uses_signatures:
      - Strategy_sig.S

  - id: optimize_cli
    module: Optimize_main
    file_ml: agents_workspace/bin/optimize_main.ml
    file_mli: null
    description: CLI runner that loads a JSON job and performs guarded parameter search (grid/random/LHS/Bayes), supporting params_override, robustness bumps, and caching; exports CSV/JSON outputs.
    signature: null
    entry_value: run_job
    entry_type: "job_file:string -> unit"
    uses_modules:
      - Strategy_fast
      - Parameters
      - Guardrails
      - Optimizer
      - Opt_algos
      - Stat_tests
      - Robustness
      - Summary
      - Strategy_b1b2
      - Vwap_revert_strategy
    uses_signatures: []

  - id: list_setup_days
    module: List_setup_days
    file_ml: agents_workspace/bin/list_setup_days.ml
    file_mli: null
    description: CLI to run B1/B2 pure strategy over a CSV and report setup days vs filtered-out days with hashes.
    signature: null
    entry_value: main
    entry_type: "string -> unit  # csv path via argv"
    uses_modules:
      - Strategy_fast
      - Engine
      - Strategy_b1b2
      - Csv_parser
    uses_signatures:
      - Strategy_sig.S

tools:
  - path: agents_workspace/tools/plot_trades.py
    summary: Python matplotlib/pandas plotter for trades/daily CSVs (R/USD/pct equity curves and histograms).
    used_by:
      - b1b2_cli
      - vwap_revert_cli
